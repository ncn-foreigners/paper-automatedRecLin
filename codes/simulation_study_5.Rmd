---
title: "Simulation study, Scenario-I, p_A ~ 0.5"
output: html_document
---

Loading necessary packages.

```{r}
library(automatedRecLin)
library(data.table)
library(readr)
library(phonics)
library(tidyr)
library(knitr)
library(reclin2)
```

Reading and cleaning data. Creating Soundex columns.

```{r}
census <- read_csv("../data-raw/census.csv", show_col_types = FALSE)
cis <- read_csv("../data-raw/cis.csv", show_col_types = FALSE)
prd <- read_csv("../data-raw/prd.csv", show_col_types = FALSE)

census <- as.data.frame(lapply(census, as.character))
census[is.na(census)] <- ""
cis <- as.data.frame(lapply(cis, as.character))
cis[is.na(cis)] <- ""
prd <- as.data.frame(lapply(prd, as.character))
prd[is.na(prd)] <- ""

census_soundex <- copy(census)
cis_soundex <- copy(cis)
prd_soundex <- copy(prd)
set(census_soundex, j = "PERNAME1", value = soundex(census_soundex[["PERNAME1"]]))
set(census_soundex, j = "PERNAME2", value = soundex(census_soundex[["PERNAME2"]]))
census_soundex <- separate(census_soundex, PERNAME1,
                           into = c("P11", "P12", "P13", "P14"), sep = 1:3)
census_soundex <- separate(census_soundex, PERNAME2,
                           into = c("P21", "P22", "P23", "P24"), sep = 1:3)
set(cis_soundex, j = "PERNAME1", value = soundex(cis_soundex[["PERNAME1"]]))
set(cis_soundex, j = "PERNAME2", value = soundex(cis_soundex[["PERNAME2"]]))
cis_soundex <- separate(cis_soundex, PERNAME1,
                        into = c("P11", "P12", "P13", "P14"), sep = 1:3)
cis_soundex <- separate(cis_soundex, PERNAME2,
                        into = c("P21", "P22", "P23", "P24"), sep = 1:3)
set(prd_soundex, j = "PERNAME1", value = soundex(prd_soundex[["PERNAME1"]]))
set(prd_soundex, j = "PERNAME2", value = soundex(prd_soundex[["PERNAME2"]]))
prd_soundex <- separate(prd_soundex, PERNAME1,
                        into = c("P11", "P12", "P13", "P14"), sep = 1:3)
prd_soundex <- separate(prd_soundex, PERNAME2,
                        into = c("P21", "P22", "P23", "P24"), sep = 1:3)

setDT(census)
setDT(cis)
setDT(prd)
setDT(census_soundex)
setDT(cis_soundex)
setDT(prd_soundex)
```

Setting the parameters.

```{r}
n_A <- 500
n_B <- 1000
ids <- census$PERSON_ID
variables <- c("PERNAME1", "PERNAME2", "SEX",
               "DOB_DAY", "DOB_MON", "DOB_YEAR")
variables_soundex <- c("P11", "P12", "P13", "P14",
                       "P21", "P22", "P23", "P24", "SEX",
                       "DOB_DAY", "DOB_MON", "DOB_YEAR")
comparators <- list(
  "PERNAME1" = jarowinkler_complement(),
  "PERNAME2" = jarowinkler_complement()
)
methods_cpar <- list(
  "PERNAME1" = "continuous_parametric",
  "PERNAME2" = "continuous_parametric"
)
methods_cnonpar <- list(
  "PERNAME1" = "continuous_nonparametric",
  "PERNAME2" = "continuous_nonparametric"
)
```

Sampling.

```{r}
set.seed(1)
p_A_5 <- 0.5
n_0_5 <- n_B / p_A_5
ids_sample_5 <- sample(ids, n_0_5)

ids_prd_5 <- sample(ids_sample_5, n_A)
ids_cis_5 <- sample(ids_sample_5, n_B)

prd_sample_5 <- prd[PERSON_ID %in% ids_prd_5, ]
cis_sample_5 <- cis[PERSON_ID %in% ids_cis_5, ]
prd_soundex_sample_5 <- prd_soundex[PERSON_ID %in% ids_prd_5, ]
cis_soundex_sample_5 <- cis_soundex[PERSON_ID %in% ids_cis_5, ]

matches_5 <- merge(x = prd_sample_5[, .(x=1:.N, PERSON_ID)],
                   y = cis_sample_5[, .(y = 1:.N, PERSON_ID)],
                   by = "PERSON_ID")
setnames(matches_5, c("x", "y"), c("a", "b"))
set(matches_5, j = "PERSON_ID", value = NULL)
```

+ `r NROW(prd_sample_5)` rows in `prd_sample_5` and `prd_soundex_sample_5` datasets.
+ `r NROW(cis_sample_5)` rows in `cis_sample_5` and `cis_soundex_sample_5` datasets.
+ `r NROW(matches_5)` matches.

### `set_construction = "size"`

`result_5_b` and `result_soundex_5_b` were obtained using the existing method. `result_5_cpar`, `result_5_cnonpar` and `result_5_cnonpar_hurdle` were obtained using the proposed method.

```{r}
set.seed(1)
result_5_b <- mec(prd_sample_5, cis_sample_5,
                  variables = variables,
                  true_matches = matches_5)
result_soundex_5_b <- mec(prd_soundex_sample_5, cis_soundex_sample_5,
                          variables = variables_soundex,
                          true_matches = matches_5)
result_5_cpar <- mec(prd_sample_5, cis_sample_5,
                     variables = variables,
                     true_matches = matches_5,
                     comparators = comparators,
                     methods = methods_cpar)
result_5_cnonpar <- mec(prd_sample_5, cis_sample_5,
                        variables = variables,
                        true_matches = matches_5,
                        comparators = comparators,
                        methods = methods_cnonpar)
result_5_cnonpar_hurdle <- mec(prd_sample_5, cis_sample_5,
                               variables = variables,
                               true_matches = matches_5,
                               comparators = comparators,
                               methods = methods_cnonpar,
                               nonpar_hurdle = TRUE)

# result_5_b
# result_soundex_5_b
# result_5_cpar
# result_5_cnonpar
# result_5_cnonpar_hurdle
```

Comparison.

```{r}
metrics_5_b <- unlist(c(n_M_est = result_5_b$n_M_est / 100, flr_est = result_5_b$flr_est,
                        mmr_est = result_5_b$mmr_est, unlist(result_5_b$eval_metrics)))
metrics_soundex_5_b <- unlist(c(n_M_est = result_soundex_5_b$n_M_est / 100, flr_est = result_soundex_5_b$flr_est,
                        mmr_est = result_soundex_5_b$mmr_est, unlist(result_soundex_5_b$eval_metrics)))
metrics_5_cpar <- unlist(c(n_M_est = result_5_cpar$n_M_est / 100, flr_est = result_5_cpar$flr_est,
                        mmr_est = result_5_cpar$mmr_est, unlist(result_5_cpar$eval_metrics)))
metrics_5_cnonpar <- unlist(c(n_M_est = result_5_cnonpar$n_M_est / 100, flr_est = result_5_cnonpar$flr_est,
                           mmr_est = result_5_cnonpar$mmr_est, unlist(result_5_cnonpar$eval_metrics)))
metrics_5_cnonpar_hurdle <- unlist(c(n_M_est = result_5_cnonpar_hurdle$n_M_est / 100, flr_est = result_5_cnonpar_hurdle$flr_est,
                              mmr_est = result_5_cnonpar_hurdle$mmr_est, unlist(result_5_cnonpar_hurdle$eval_metrics)))

results_5_size <- list(
  "binary" = metrics_5_b,
  "binary_soundex" = metrics_soundex_5_b,
  "cpar" = metrics_5_cpar,
  "cnonpar" = metrics_5_cnonpar,
  "cnonpar_hurdle" = metrics_5_cnonpar_hurdle
)
table_5_size <- data.frame(round(do.call(rbind, results_5_size) * 100, 4))
kable(table_5_size)
```

### `set_construction = "flr"`, `target_flr = 0.03`

`result_5_b_flr_03` and `result_soundex_5_b_flr_03` were obtained using the existing method. `result_5_cpar_flr_03`, `result_5_cnonpar_flr_03` and `result_5_cnonpar_hurdle_flr_03` were obtained using the proposed method.

```{r}
set.seed(1)
result_5_b_flr_03 <- mec(prd_sample_5, cis_sample_5,
                         variables = variables,
                         true_matches = matches_5,
                         set_construction = "flr")
result_soundex_5_b_flr_03 <- mec(prd_soundex_sample_5, cis_soundex_sample_5,
                                 variables = variables_soundex,
                                 true_matches = matches_5,
                                 set_construction = "flr")
result_5_cpar_flr_03 <- mec(prd_sample_5, cis_sample_5,
                            variables = variables,
                            true_matches = matches_5,
                            comparators = comparators,
                            methods = methods_cpar,
                            set_construction = "flr")
result_5_cnonpar_flr_03 <- mec(prd_sample_5, cis_sample_5,
                               variables = variables,
                               true_matches = matches_5,
                               comparators = comparators,
                               methods = methods_cnonpar,
                               set_construction = "flr")
result_5_cnonpar_hurdle_flr_03 <- mec(prd_sample_5, cis_sample_5,
                                      variables = variables,
                                      true_matches = matches_5,
                                      comparators = comparators,
                                      methods = methods_cnonpar,
                                      nonpar_hurdle = TRUE,
                                      set_construction = "flr")

# result_5_b_flr_03
# result_soundex_5_b_flr_03
# result_5_cpar_flr_03
# result_5_cnonpar_flr_03
# result_5_cnonpar_hurdle_flr_03
```

Comparison.

```{r}
metrics_5_b_flr_03 <- unlist(c(n_M_est = result_5_b_flr_03$n_M_est / 100, flr_est = result_5_b_flr_03$flr_est,
                        mmr_est = result_5_b_flr_03$mmr_est, unlist(result_5_b_flr_03$eval_metrics)))
metrics_soundex_5_b_flr_03 <- unlist(c(n_M_est = result_soundex_5_b_flr_03$n_M_est / 100, flr_est = result_soundex_5_b_flr_03$flr_est,
                                mmr_est = result_soundex_5_b_flr_03$mmr_est, unlist(result_soundex_5_b_flr_03$eval_metrics)))
metrics_5_cpar_flr_03 <- unlist(c(n_M_est = result_5_cpar_flr_03$n_M_est / 100, flr_est = result_5_cpar_flr_03$flr_est,
                           mmr_est = result_5_cpar_flr_03$mmr_est, unlist(result_5_cpar_flr_03$eval_metrics)))
metrics_5_cnonpar_flr_03 <- unlist(c(n_M_est = result_5_cnonpar_flr_03$n_M_est / 100, flr_est = result_5_cnonpar_flr_03$flr_est,
                              mmr_est = result_5_cnonpar_flr_03$mmr_est, unlist(result_5_cnonpar_flr_03$eval_metrics)))
metrics_5_cnonpar_hurdle_flr_03 <- unlist(c(n_M_est = result_5_cnonpar_hurdle_flr_03$n_M_est / 100, flr_est = result_5_cnonpar_hurdle_flr_03$flr_est,
                                     mmr_est = result_5_cnonpar_hurdle_flr_03$mmr_est, unlist(result_5_cnonpar_hurdle_flr_03$eval_metrics)))

results_5_flr_03 <- list(
  "binary" = metrics_5_b_flr_03,
  "binary_soundex" = metrics_soundex_5_b_flr_03,
  "cpar" = metrics_5_cpar_flr_03,
  "cnonpar" = metrics_5_cnonpar_flr_03,
  "cnonpar_hurdle" = metrics_5_cnonpar_hurdle_flr_03
)
table_5_flr_03 <- data.frame(round(do.call(rbind, results_5_flr_03) * 100, 4))
kable(table_5_flr_03)
```

### `set_construction = "flr"`, `target_flr = 0.05`

`result_5_b_flr_05` and `result_soundex_5_b_flr_05` were obtained using the existing method. `result_5_cpar_flr_05`, `result_5_cnonpar_flr_05` and `result_5_cnonpar_hurdle_flr_05` were obtained using the proposed method.

```{r}
set.seed(1)
result_5_b_flr_05 <- mec(prd_sample_5, cis_sample_5,
                         variables = variables,
                         true_matches = matches_5,
                         set_construction = "flr",
                         target_flr = 0.05)
result_soundex_5_b_flr_05 <- mec(prd_soundex_sample_5, cis_soundex_sample_5,
                                 variables = variables_soundex,
                                 true_matches = matches_5,
                                 set_construction = "flr",
                                 target_flr = 0.05)
result_5_cpar_flr_05 <- mec(prd_sample_5, cis_sample_5,
                            variables = variables,
                            true_matches = matches_5,
                            comparators = comparators,
                            methods = methods_cpar,
                            set_construction = "flr",
                            target_flr = 0.05)
result_5_cnonpar_flr_05 <- mec(prd_sample_5, cis_sample_5,
                               variables = variables,
                               true_matches = matches_5,
                               comparators = comparators,
                               methods = methods_cnonpar,
                               set_construction = "flr",
                               target_flr = 0.05)
result_5_cnonpar_hurdle_flr_05 <- mec(prd_sample_5, cis_sample_5,
                                      variables = variables,
                                      true_matches = matches_5,
                                      comparators = comparators,
                                      methods = methods_cnonpar,
                                      nonpar_hurdle = TRUE,
                                      set_construction = "flr",
                                      target_flr = 0.05)


# result_5_b_flr_05
# result_soundex_5_b_flr_05
# result_5_cpar_flr_05
# result_5_cnonpar_flr_05
# result_5_cnonpar_hurdle_flr_05
```

Comparison.

```{r}
metrics_5_b_flr_05 <- unlist(c(n_M_est = result_5_b_flr_05$n_M_est / 100, flr_est = result_5_b_flr_05$flr_est,
                               mmr_est = result_5_b_flr_05$mmr_est, unlist(result_5_b_flr_05$eval_metrics)))
metrics_soundex_5_b_flr_05 <- unlist(c(n_M_est = result_soundex_5_b_flr_05$n_M_est / 100, flr_est = result_soundex_5_b_flr_05$flr_est,
                                       mmr_est = result_soundex_5_b_flr_05$mmr_est, unlist(result_soundex_5_b_flr_05$eval_metrics)))
metrics_5_cpar_flr_05 <- unlist(c(n_M_est = result_5_cpar_flr_05$n_M_est / 100, flr_est = result_5_cpar_flr_05$flr_est,
                                  mmr_est = result_5_cpar_flr_05$mmr_est, unlist(result_5_cpar_flr_05$eval_metrics)))
metrics_5_cnonpar_flr_05 <- unlist(c(n_M_est = result_5_cnonpar_flr_05$n_M_est / 100, flr_est = result_5_cnonpar_flr_05$flr_est,
                                     mmr_est = result_5_cnonpar_flr_05$mmr_est, unlist(result_5_cnonpar_flr_05$eval_metrics)))
metrics_5_cnonpar_hurdle_flr_05 <- unlist(c(n_M_est = result_5_cnonpar_hurdle_flr_05$n_M_est / 100, flr_est = result_5_cnonpar_hurdle_flr_05$flr_est,
                                            mmr_est = result_5_cnonpar_hurdle_flr_05$mmr_est, unlist(result_5_cnonpar_hurdle_flr_05$eval_metrics)))

results_5_flr_05 <- list(
  "binary" = metrics_5_b_flr_05,
  "binary_soundex" = metrics_soundex_5_b_flr_05,
  "cpar" = metrics_5_cpar_flr_05,
  "cnonpar" = metrics_5_cnonpar_flr_05,
  "cnonpar_hurdle" = metrics_5_cnonpar_hurdle_flr_05
)
table_5_flr_05 <- data.frame(round(do.call(rbind, results_5_flr_05) * 100, 4))
kable(table_5_flr_05)
```

### Fellegi-Sunter model

```{r}
set.seed(1)
pairs_5 <- pair(prd_soundex_sample_5, cis_soundex_sample_5)
compare_pairs(pairs_5, on = variables_soundex, inplace = TRUE)
model <- problink_em(~ P11 + P12 + P13 + P14 + P21 + P22 + P23 + P24 + SEX + DOB_DAY + DOB_MON + DOB_YEAR, data = pairs_5)
pairs_5 <- predict(model, pairs_5, type = "mpost", add = TRUE, binary = TRUE)
pairs_5 <- select_n_to_m(pairs_5, "ntom", "mpost", 0.95)
setDT(pairs_5)
pairs_5 <- pairs_5[ntom == TRUE, ]
pairs_5 <- pairs_5[, c(".x", ".y")]
setnames(pairs_5, c(".x", ".y"), c("a", "b"))

f_s_5_eval <- evaluation(pairs_5, matches_5, n = NROW(prd_soundex_sample_5) * NROW(cis_soundex_sample_5))
f_s_5_metrics <- get_metrics(f_s_5_eval[[1]], f_s_5_eval[[2]], f_s_5_eval[[3]], f_s_5_eval[[4]])
table_fs_5 <- data.frame(rbind(round(c(n_M_est = NROW(pairs_5), (unlist(f_s_5_metrics) * 100)), 2)))
rownames(table_fs_5) <- "fellegi_sunter"
kable(table_fs_5)
```